<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Unread Emails to Speech</title>
    <style>
      /* General Reset */
      body {
        margin: 0;
        font-family: Arial, sans-serif;
        line-height: 1.6;
        color: #333;
        background-color: #f9f9f9;
      }

      h1 {
        text-align: center;
        margin: 20px 0;
        color: #2c3e50;
      }

      ul {
        list-style: none;
        padding: 0;
      }

      li {
        background-color: #ffffff;
        margin: 15px auto;
        padding: 15px;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        max-width: 800px;
      }

      li strong {
        color: #2980b9;
      }

      #synthesisForm {
        text-align: center;
        margin: 20px 0;
      }

      #synthesisForm button {
        background-color: #3498db;
        color: #fff;
        border: none;
        padding: 10px 20px;
        font-size: 16px;
        cursor: pointer;
        border-radius: 5px;
        transition: background-color 0.3s ease;
      }

      #synthesisForm button:hover {
        background-color: #2980b9;
      }

      #audioContainer {
        text-align: center;
        margin: 20px 0;
      }

      .loading {
        display: inline-block;
        padding: 10px;
        background-color: #ffecb3;
        border-radius: 4px;
        font-weight: bold;
        color: #ff9800;
        margin: 10px auto;
      }

      .error {
        display: inline-block;
        padding: 10px;
        background-color: #ffcccc;
        border-radius: 4px;
        font-weight: bold;
        color: #e74c3c;
        margin: 10px auto;
      }

      audio {
        margin: 15px auto;
      }

      /* Small screens */
      @media (max-width: 600px) {
        li {
          padding: 10px;
          font-size: 14px;
        }

        #synthesisForm button {
          padding: 8px 16px;
          font-size: 14px;
        }
      }
    </style>
    <script>
      let isProcessing = false;
      let currentAudioFile = null;

      // Function to continuously check for new audio files
      function pollForNewAudio() {
        if (isProcessing) {
          fetch("/current_audio")
            .then((response) => response.json())
            .then((data) => {
              if (data.audio_file && data.audio_file !== currentAudioFile) {
                // New audio file detected
                currentAudioFile = data.audio_file;
                updateAudioPlayer(data.audio_file);
                isProcessing = false;
              } else {
                // Continue polling if still processing
                setTimeout(pollForNewAudio, 1000);
              }
            })
            .catch((error) => {
              console.error("Error polling for audio:", error);
              isProcessing = false;
            });
        }
      }

      // Function to update the audio player
      function updateAudioPlayer(audioFile) {
        const audioContainer = document.getElementById("audioContainer");
        const timestamp = new Date().getTime(); // Add timestamp to prevent caching
        audioContainer.innerHTML = `
            <h3 style="color: #27ae60;">Audio Generated:</h3>
            <audio controls autoplay>
                <source src="/audio/${audioFile}?t=${timestamp}" type="audio/wav">
                Your browser does not support the audio element.
            </audio>
        `;
      }

      // Function to handle the synthesis process
      function startSynthesis() {
        if (!isProcessing) {
          isProcessing = true;
          const audioContainer = document.getElementById("audioContainer");
          audioContainer.innerHTML =
            '<div class="loading">Generating audio... Please wait...</div>';

          fetch("/synthesize_voice", {
            method: "POST",
          })
            .then((response) => response.json())
            .then((data) => {
              if (data.status === "success") {
                pollForNewAudio();
              } else {
                audioContainer.innerHTML =
                  '<div class="error">Error generating audio</div>';
                isProcessing = false;
              }
            })
            .catch((error) => {
              console.error("Error:", error);
              audioContainer.innerHTML =
                '<div class="error">Error generating audio</div>';
              isProcessing = false;
            });
        }
      }
      // Function to check for "read email" command
      function checkForReadEmail() {
        fetch("/transcription")
          .then((response) => response.json())
          .then((data) => {
            const command = data.transcription.toLowerCase();
            if (
              command === "read email" ||
              command === "read e-mail" ||
              command === "read email." ||
              command === "read e-mail." ||
              command === "read e-mail!"
            ) {
              console.log("Voice command detected: read email");
              startSynthesis();
            }
          })
          .catch((error) =>
            console.error("Error checking transcription:", error)
          );
      }

      // Handle manual synthesis button
      function handleManualSynthesis(event) {
        event.preventDefault();
        startSynthesis();
      }

      // Initialize everything when the page loads
      window.onload = function () {
        // Set up the form handler
        const form = document.getElementById("synthesisForm");
        if (form) {
          form.addEventListener("submit", handleManualSynthesis);
        }

        // Start checking for voice commands
        setInterval(checkForReadEmail, 1000);

        // If there's already an audio file, display it
        fetch("/current_audio")
          .then((response) => response.json())
          .then((data) => {
            if (data.audio_file) {
              currentAudioFile = data.audio_file;
              updateAudioPlayer(data.audio_file);
            }
          })
          .catch((error) =>
            console.error("Error checking current audio:", error)
          );
      };
    </script>
  </head>
  <body>
    <h1>Unread Emails to Speech</h1>

    {% if emails %}
    <ul>
      {% for email in emails %}
      <li>
        <strong>From:</strong> {{ email.from }}<br />
        <strong>Subject:</strong> {{ email.subject }}<br />
        <strong>Body:</strong> <br />{{ email.body }}<br /><br />
      </li>
      {% endfor %}
    </ul>

    <form id="synthesisForm">
      <button type="submit">Synthesize Audio for All Unread Emails</button>
    </form>

    <p style="text-align: center; font-size: 14px; color: #7f8c8d">
      <small>You can also say "read email" to trigger synthesis</small>
    </p>
    {% endif %}

    <div id="audioContainer">
      {% if audio_file %}
      <h3 style="text-align: center; color: #27ae60">Audio Generated:</h3>
      <audio controls autoplay>
        <source
          src="{{ url_for('serve_audio', filename=audio_file) }}"
          type="audio/wav"
        />
        Your browser does not support the audio element.
      </audio>
      {% endif %}
    </div>
  </body>
</html>
